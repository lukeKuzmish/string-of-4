<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>string of 4</title>

    <style type='text/css'>
      * {
        font-family:    'Helvetica', sans serif;
      }
      
      #shareLinkSpan {
        display:    none;
      }
    </style>
    
    <script type="text/javascript" src="js/jquery-1.6.4.min.js"> </script>
  </head>
  <body>

    <div id="wrapper">
      <div id="startGameDiv">
	      <form id="startGameForm">
        	  <span>pick your color</span>
        	  
          <select id="player1ColorChoice">
            <option value="r">Red</option>
            <option value="b">Black</option>
          </select>

		      <input type="submit" value="Begin Game" id="startGame" />
	      </form>
	    </div>


      <span id="shareLinkSpan">Give this link to a friend: </span>
      <div id="gameContainer" padding='1'>
        <table id="gameboardTable"></table>
      </div>
    </div>
    
    <script>
      // setting up string-of-4 namespace
      var gameSpace = gameSpace || {};
      gameSpace.my_color = 'r';
      gameSpace.playerNumber = 1;
      gameSpace.game_state = {};


  // stolen from http://stackoverflow.com/questions/470832/getting-an-absolute-url-from-a-relative-one-ie6-issue
      function createAbsoluteURL(url) {
        var a = document.createElement('a');
        a.href = url;
        return a.href;
      }



      // getURLParam from http://stackoverflow.com/questions/1403888/get-url-parameter-with-jquery
      // by JIP
      function getURLParam(name) {
        var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.search);
        if (results === null) { return null; }
        return results[1] || 1;
      }


      function setup_your_move() {
        // animations when it's your turn
      }



      function make_move(col) {
        // handle graphics, backend logic,  legality of move

		    // legality
			  //TODO check state
			
			  if (gameSpace.game_state.next_move !== gameSpace.playerNumber) {
			    console.log('not your turn, toughguy');
				  // not your turn
				  return false;
			  }
			
			  var len = gameSpace.game_state.gameboard.length;
			  
			  for (var row=0; row<len; row++) {
				  if (gameSpace.game_state.gameboard[col][row]===0) {
				    console.log('dropping in column ' + col);
					  // TODO send message to server
            $.getJSON('move.php',
                { game_id : gameSpace.game_state.game_id, column : col },
                function(response) {
                    gameSpace.game_state = response;
                    if (gameSpace.game_state.error === undefined) {
                      // successful move
                      console.log('move.php request success');
    						        drawMove(row,col);
  						        }
  						        else {
                        alert('error from move.php.  ' + gameSpace.gamestate.error);
  						        }
            });
            return true;
				  }
			  }
			  
			  // column is full, choose another TODO
			  alert('column is full, choose another');
			  return false;
				
				
			  
     }
 
      
      function loadGame(game_state) {
        //  for joining a game        
        if (game_state.error === undefined) {
          // no error detected, load in data
          gameSpace.game_state = game_state;
          gameSpace.playerNumber = 2;
          gameSpace.my_color = game_state.next_move;
          drawBoard();
        }

        else {
          // TODO handle error that is described in game_state.error
          console.log(game_state.error);
        }
        
      }


      function drawBoard() {
        var contentToAdd,
            len = gameSpace.game_state.gameboard.length;
        for (var row=len-1; row>=0; row--) {
          contentToAdd += '<tr>';
          for (var col=0; col<len; col++) {
            contentToAdd += "<td>" + gameSpace.game_state.gameboard[col][row] + "</td>";
            console.log('drawing ' + row + ' ' + col);
          }
          contentToAdd += '</tr>';
        }

        $('#gameboardTable').append(contentToAdd);
        
      		// TODO td that is a child of #gameboardTable, think it's #gameboardTable > td
	      	$('td').bind('click',function() { make_move(this.cellIndex);});
      }
      

      function drawMove(row,col) {
		    $('#gameboardTable').html('');
		    drawBoard();
      }

      
      
      // document load
      $(document).ready(function() {

        var param_game_id = getURLParam('game_id');
        if (param_game_id !== null) {
          // TODO hide everything that shouldn't be displayed provided game_id was passed by GET
          $.getJSON('joingame.php',
            { game_id : param_game_id },
            function(response) {
              loadGame(response);
              $('#startGameDiv').hide();
          });
        }

        else {
          // no params, set up display
          console.log("no param");
        }
        
        $('#startGameForm').submit(function(e) {
            // user clicks to start new game
            var player1_color_choice = 'r';
            player1_color_choice = $('#player1ColorChoice').val();

            if ((player1_color_choice !== 'r') && (player1_color_choice !== 'b')) {
              // TODO check that input is valid (r or b)
              alert('nice try, but you must pick either red or black for your color');
              return false;
            }

            
            gameSpace.my_color = player1_color_choice;
            
            $.getJSON('newgame.php',
                      { color_choice : gameSpace.my_color },
                      function(response) {
                        console.log(response.game_id);
                        gameSpace.game_state = response;
                        var link_to_share = createAbsoluteURL('index.html?game_id=' + gameSpace.game_state.game_id);
                        $('#shareLinkSpan').append('<br />' + link_to_share);
                        $('#startGameForm').hide();
                        $('#shareLinkSpan').show();
                      });
            
            console.log(player1_color_choice);
            return false;
        });   // #startGameForm submit
        
      }); // document wrapper
    
    </script>
  </body>
</html>
